<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Tarifas - CABA Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">CABA Pro Admin</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/admin/torneos">Torneos</a>
                <a class="nav-link active" href="/admin/tarifas">Tarifas</a>
                <a class="nav-link" href="/admin/liquidaciones">Liquidaciones</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1>Gestión de Tarifas</h1>
        
        <!-- Botón para crear nueva tarifa -->
        <button class="btn btn-primary mb-3" onclick="mostrarFormularioCrear()">
            Nueva Tarifa
        </button>
        
        <!-- Formulario para crear/editar tarifa (inicialmente oculto) -->
        <div id="formularioTarifa" class="card mb-3" style="display: none;">
            <div class="card-header">
                <h5 id="tituloFormulario">Crear Nueva Tarifa</h5>
            </div>
            <div class="card-body">
                <form id="formTarifa">
                    <input type="hidden" id="tarifaId" />
                    <div class="mb-3">
                        <label for="monto" class="form-label">Monto</label>
                        <input type="number" class="form-control" id="monto" required min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="mb-3">
                        <label for="escalafon" class="form-label">Escalafón</label>
                        <select class="form-control" id="escalafon" required>
                            <option value="">Seleccione un escalafón</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="torneo" class="form-label">Torneo</label>
                        <select class="form-control" id="torneo" required>
                            <option value="">Seleccione un torneo</option>
                            <!-- Los torneos se cargan dinámicamente -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelarFormulario()">Cancelar</button>
                </form>
            </div>
        </div>
        
        <!-- Tabla de tarifas -->
        <div class="card">
            <div class="card-header">
                <h5>Lista de Tarifas</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Monto</th>
                            <th>Escalafón</th>
                            <th>Torneo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaTarifas">
                        <!-- Los datos se cargan dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JavaScript para conectar con backend
        const API_URL = '/api/tarifas';
        const TORNEOS_URL = '/api/torneos';
        
        // Cargar tarifas al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarTarifas();
            cargarTorneos();
        });
        
        // Función para cargar torneos en el dropdown
        function cargarTorneos() {
            fetch(TORNEOS_URL, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('user:751c919b-981f-460e-8fbe-5324316d558e')
                }
            })
                .then(response => response.json())
                .then(torneos => {
                    const select = document.getElementById('torneo');
                    // Limpiar opciones existentes excepto la primera
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    torneos.forEach(torneo => {
                        const option = document.createElement('option');
                        option.value = torneo.id;
                        option.textContent = torneo.nombre;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar torneos:', error);
                });
        }
        
        // Función para cargar todas las tarifas
        function cargarTarifas() {
            fetch(API_URL, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('user:751c919b-981f-460e-8fbe-5324316d558e')
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta: ' + response.status);
                    }
                    if (response.status === 204) {
                        return [];
                    }
                    return response.json();
                })
                .then(tarifas => {
                    const tbody = document.getElementById('tablaTarifas');
                    tbody.innerHTML = '';
                    tarifas.forEach(tarifa => {
                        const escalafon = obtenerBadgeEscalafon(tarifa.escalafon);
                        const torneoNombre = tarifa.torneo ? tarifa.torneo.nombre : 'Sin torneo';
                        const row = `
                            <tr>
                                <td>${tarifa.id}</td>
                                <td>$${parseFloat(tarifa.monto).toFixed(2)}</td>
                                <td>${escalafon}</td>
                                <td>${torneoNombre}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="editarTarifa(${tarifa.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarTarifa(${tarifa.id})">Eliminar</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar las tarifas: ' + error.message);
                });
        }
        
        // Función para obtener badge de escalafón
        function obtenerBadgeEscalafon(escalafon) {
            const badges = {
                'A': '<span class="badge bg-success">A</span>',
                'B': '<span class="badge bg-info">B</span>',
                'C': '<span class="badge bg-warning">C</span>',
                'D': '<span class="badge bg-secondary">D</span>'
            };
            return badges[escalafon] || `<span class="badge bg-light text-dark">${escalafon}</span>`;
        }
        
        // Función para mostrar formulario de crear
        function mostrarFormularioCrear() {
            document.getElementById('formularioTarifa').style.display = 'block';
            document.getElementById('tituloFormulario').textContent = 'Crear Nueva Tarifa';
            document.getElementById('formTarifa').reset();
            document.getElementById('tarifaId').value = '';
        }
        
        // Función para editar tarifa
        function editarTarifa(id) {
            fetch(`${API_URL}/${id}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('user:751c919b-981f-460e-8fbe-5324316d558e')
                }
            })
                .then(response => response.json())
                .then(tarifa => {
                    document.getElementById('formularioTarifa').style.display = 'block';
                    document.getElementById('tituloFormulario').textContent = 'Editar Tarifa';
                    document.getElementById('tarifaId').value = tarifa.id;
                    document.getElementById('monto').value = tarifa.monto;
                    document.getElementById('escalafon').value = tarifa.escalafon;
                    document.getElementById('torneo').value = tarifa.torneo ? tarifa.torneo.id : '';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar la tarifa: ' + error.message);
                });
        }
        
        // Función para eliminar tarifa
        function eliminarTarifa(id) {
            if (confirm('¿Está seguro de eliminar esta tarifa?')) {
                fetch(`${API_URL}/${id}`, { 
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Basic ' + btoa('user:751c919b-981f-460e-8fbe-5324316d558e')
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Tarifa eliminada exitosamente');
                        cargarTarifas();
                    } else {
                        throw new Error('Error al eliminar');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar la tarifa: ' + error.message);
                });
            }
        }
        
        // Manejar submit del formulario
        document.getElementById('formTarifa').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const monto = parseFloat(document.getElementById('monto').value);
            if (monto <= 0) {
                alert('El monto debe ser mayor a 0');
                return;
            }
            
            const tarifa = {
                monto: monto,
                escalafon: document.getElementById('escalafon').value,
                torneo: {
                    id: parseInt(document.getElementById('torneo').value)
                }
            };
            
            const tarifaId = document.getElementById('tarifaId').value;
            const method = tarifaId ? 'PUT' : 'POST';
            const url = tarifaId ? `${API_URL}/${tarifaId}` : API_URL;
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('user:751c919b-981f-460e-8fbe-5324316d558e')
                },
                body: JSON.stringify(tarifa)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Error en la operación');
                }
            })
            .then(() => {
                alert(tarifaId ? 'Tarifa actualizada exitosamente' : 'Tarifa creada exitosamente');
                cancelarFormulario();
                cargarTarifas();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar la tarifa: ' + error.message);
            });
        });
        
        // Función para cancelar formulario
        function cancelarFormulario() {
            document.getElementById('formularioTarifa').style.display = 'none';
            document.getElementById('formTarifa').reset();
        }
    </script>
</body>
</html>
