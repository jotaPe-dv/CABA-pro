<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head}"></head>
<body>
    <nav th:replace="~{fragments/layout :: navbar}"></nav>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="d-flex flex-column p-3">
                    <h6 class="text-muted mb-3">ÁRBITRO</h6>
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a href="/arbitro/dashboard" class="nav-link">
                                <i class="bi bi-speedometer2 me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/arbitro/chat" class="nav-link active">
                                <i class="bi bi-chat-dots me-2"></i>Chat con Administración
                                <span id="badge-total-no-leidos" class="badge bg-danger ms-2" style="display: none;">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/asignaciones/mis-asignaciones" class="nav-link">
                                <i class="bi bi-calendar-check me-2"></i>Mis Asignaciones
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/arbitro/perfil" class="nav-link">
                                <i class="bi bi-person me-2"></i>Mi Perfil
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Main Content - Chat con Admin -->
            <div class="col-md-9 col-lg-10 main-content p-0">
                <div class="d-flex flex-column h-100">
                    <!-- Header del Chat -->
                    <div class="p-3 border-bottom bg-white">
                        <div class="d-flex align-items-center">
                            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="bi bi-shield-fill"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-chat-dots me-2"></i>Chat con Administración
                                </h5>
                                <small class="text-muted">Comunícate con el equipo administrativo</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensajes -->
                    <div id="messages-container" class="flex-grow-1 overflow-auto p-3 bg-light" style="height: calc(100vh - 200px);">
                        <div class="text-center text-muted p-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando mensajes...</span>
                            </div>
                            <p class="mt-3">Cargando conversación...</p>
                        </div>
                    </div>
                    
                    <!-- Input de Mensaje -->
                    <div class="p-3 border-top bg-white">
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" 
                                   placeholder="Escribe un mensaje a la administración..." 
                                   autocomplete="off">
                            <button class="btn btn-primary" type="button" id="send-button">
                                <i class="bi bi-send-fill"></i> Enviar
                            </button>
                        </div>
                        <small class="text-muted" id="typing-indicator" style="display: none;">
                            <i class="bi bi-three-dots"></i> La administración está escribiendo...
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden data -->
    <input type="hidden" id="usuario-actual-id" th:value="${usuarioActual.id}">
    <input type="hidden" id="usuario-actual-nombre" th:value="${usuarioActual.nombreCompleto}">
    
    <!-- SockJS y STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <script th:inline="javascript">
        let stompClient = null;
        let adminId = null;
        const usuarioActualId = document.getElementById('usuario-actual-id').value;
        const usuarioActualNombre = document.getElementById('usuario-actual-nombre').value;
        
        document.addEventListener('DOMContentLoaded', function() {
            conectarWebSocket();
            cargarAdmin();
            actualizarContadorNoLeidos();
            
            // Event listeners
            document.getElementById('send-button').addEventListener('click', enviarMensaje);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enviarMensaje();
                }
            });
        });
        
        function conectarWebSocket() {
            const socket = new SockJS('/ws-chat');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Conectado a WebSocket: ' + frame);
                
                stompClient.subscribe('/topic/chat/' + usuarioActualId, function(mensaje) {
                    const mensajeDTO = JSON.parse(mensaje.body);
                    recibirMensaje(mensajeDTO);
                });
                
                stompClient.subscribe('/topic/chat/typing/' + usuarioActualId, function(data) {
                    const info = JSON.parse(data.body);
                    mostrarIndicadorEscribiendo(info);
                });
            }, function(error) {
                console.error('Error WebSocket:', error);
                setTimeout(conectarWebSocket, 5000);
            });
        }
        
        async function cargarAdmin() {
            try {
                // Buscar el primer administrador disponible
                const response = await fetch('/api/administradores/principal');
                const data = await response.json();
                
                if (data.success) {
                    adminId = data.administrador.id;
                    cargarMensajes();
                }
            } catch (error) {
                console.error('Error cargando admin:', error);
                // Usar admin por defecto (ID 1)
                adminId = 1;
                cargarMensajes();
            }
        }
        
        async function cargarMensajes() {
            if (!adminId) return;
            
            try {
                const response = await fetch(`/api/chat/conversacion/${adminId}`);
                const data = await response.json();
                
                if (data.success) {
                    mostrarMensajes(data.mensajes);
                    actualizarContadorNoLeidos();
                }
            } catch (error) {
                console.error('Error cargando mensajes:', error);
                document.getElementById('messages-container').innerHTML = `
                    <div class="text-center text-muted p-5">
                        <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Error al cargar mensajes</h5>
                        <button class="btn btn-primary mt-2" onclick="cargarMensajes()">Reintentar</button>
                    </div>
                `;
            }
        }
        
        function mostrarMensajes(mensajes) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            
            if (mensajes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-5">
                        <i class="bi bi-chat-text" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No hay mensajes aún</h5>
                        <p>¡Inicia la conversación con la administración!</p>
                    </div>
                `;
                return;
            }
            
            mensajes.forEach(mensaje => {
                agregarMensajeAChat(mensaje, false);
            });
            
            scrollToBottom();
        }
        
        function agregarMensajeAChat(mensaje, animar = true) {
            const container = document.getElementById('messages-container');
            const esMio = mensaje.remitenteId == usuarioActualId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message mb-3 ${esMio ? 'text-end' : ''}`;
            if (animar) messageDiv.style.opacity = '0';
            
            const fecha = new Date(mensaje.fechaEnvio);
            const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="d-inline-block ${esMio ? 'bg-primary text-white' : 'bg-white border'} rounded p-2 px-3" style="max-width: 70%;">
                    ${!esMio ? `<small class="fw-bold text-primary d-block"><i class="bi bi-shield-fill"></i> Administración</small>` : ''}
                    <div>${escapeHtml(mensaje.contenido)}</div>
                    <small class="text-${esMio ? 'white-50' : 'muted'} d-block mt-1">${hora}</small>
                </div>
            `;
            
            container.appendChild(messageDiv);
            
            if (animar) {
                setTimeout(() => {
                    messageDiv.style.transition = 'opacity 0.3s';
                    messageDiv.style.opacity = '1';
                }, 10);
            }
            
            scrollToBottom();
        }
        
        function enviarMensaje() {
            const input = document.getElementById('message-input');
            const contenido = input.value.trim();
            
            if (!contenido || !adminId) return;
            
            const mensaje = {
                remitenteId: usuarioActualId,
                destinatarioId: adminId,
                contenido: contenido
            };
            
            stompClient.send('/app/chat.send', {}, JSON.stringify(mensaje));
            
            input.value = '';
            input.focus();
        }
        
        function recibirMensaje(mensaje) {
            agregarMensajeAChat(mensaje, true);
            
            if (mensaje.destinatarioId == usuarioActualId) {
                actualizarContadorNoLeidos();
                reproducirSonidoNotificacion();
            }
        }
        
        function actualizarContadorNoLeidos() {
            fetch('/api/chat/no-leidos')
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.count > 0) {
                        const badge = document.getElementById('badge-total-no-leidos');
                        badge.textContent = data.count;
                        badge.style.display = 'inline-block';
                    } else {
                        document.getElementById('badge-total-no-leidos').style.display = 'none';
                    }
                });
        }
        
        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function reproducirSonidoNotificacion() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuFzvLaizsIHGS57OihUhELTKXh8bllHAU2jdXvzX4vBSh+zPLajzsIHGO56uqkUxELTKXh8bllHAU2jdXvzX4vBSh+zPLajzsIHGO56uqkUxELTKXh8bllHAU2jdXvzX4vBSh+zPLajzsIHGO56uqkUxELTKXh8bllHAU2jdXvzX4vBQ==');
            audio.volume = 0.3;
            audio.play().catch(() => {});
        }
        
        function mostrarIndicadorEscribiendo(info) {
            if (info.escribiendo && info.usuarioId == adminId) {
                document.getElementById('typing-indicator').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('typing-indicator').style.display = 'none';
                }, 3000);
            }
        }
    </script>
    
    <style>
        .message {
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        #messages-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #messages-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        #messages-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
    
    <script th:replace="~{fragments/layout :: scripts}"></script>
</body>
</html>